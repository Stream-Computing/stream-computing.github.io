<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-推理软件使用手册/STCRP使用指南/MLTC使用指南" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">MLTC使用指南 | 希姆计算文档中心</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="MLTC使用指南 | 希姆计算文档中心"><meta data-rh="true" name="description" content="MLTC概述"><meta data-rh="true" property="og:description" content="MLTC概述"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"推理软件使用手册","item":"https://your-docusaurus-site.example.com/docs/category/推理软件使用手册"},{"@type":"ListItem","position":2,"name":"STCRP使用指南","item":"https://your-docusaurus-site.example.com/docs/category/stcrp使用指南"},{"@type":"ListItem","position":3,"name":"MLTC使用指南","item":"https://your-docusaurus-site.example.com/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="希姆计算文档中心 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="希姆计算文档中心 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.59b7a052.css">
<script src="/assets/js/runtime~main.afb2363a.js" defer="defer"></script>
<script src="/assets/js/main.f3442f90.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/stc_logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/stc_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/stc_logo.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">STC Docs Hub</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/希姆计算术语表">AI加速卡</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/希姆计算术语表">AI一体机</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/希姆计算术语表">智算云平台</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/Stream-Computing/stream-computing.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item green"><a class="menu__link" href="/docs/希姆计算术语表"><span title="希姆计算术语表" class="linkLabel_WmDU">希姆计算术语表</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/硬件产品手册"><span title="硬件产品手册" class="categoryLinkLabel_W154">硬件产品手册</span></a><button aria-label="Expand sidebar category &#x27;硬件产品手册&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/固件产品手册"><span title="固件产品手册" class="categoryLinkLabel_W154">固件产品手册</span></a><button aria-label="Expand sidebar category &#x27;固件产品手册&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/docs/category/推理软件使用手册"><span title="推理软件使用手册" class="categoryLinkLabel_W154">推理软件使用手册</span></a><button aria-label="Collapse sidebar category &#x27;推理软件使用手册&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item green"><a class="menu__link" tabindex="0" href="/docs/推理软件使用手册/STCRP Release Notes"><span title="STCRP Release Notes" class="linkLabel_WmDU">STCRP Release Notes</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item green"><a class="menu__link" tabindex="0" href="/docs/推理软件使用手册/STCRP产品简介"><span title="STCRP产品简介" class="linkLabel_WmDU">STCRP产品简介</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item green"><a class="menu__link" tabindex="0" href="/docs/推理软件使用手册/STCRP安装指南"><span title="STCRP安装指南" class="linkLabel_WmDU">STCRP安装指南</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/stcrp使用指南"><span title="STCRP使用指南" class="categoryLinkLabel_W154">STCRP使用指南</span></a><button aria-label="Collapse sidebar category &#x27;STCRP使用指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item green"><a class="menu__link" tabindex="0" href="/docs/推理软件使用手册/STCRP使用指南/HPE使用指南"><span title="HPE使用指南" class="linkLabel_WmDU">HPE使用指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item green"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南"><span title="MLTC使用指南" class="linkLabel_WmDU">MLTC使用指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item green"><a class="menu__link" tabindex="0" href="/docs/推理软件使用手册/STCRP使用指南/STC_LLM使用指南"><span title="STC_LLM使用指南" class="linkLabel_WmDU">STC_LLM使用指南</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/硬件性能测试手册"><span title="硬件性能测试手册" class="categoryLinkLabel_W154">硬件性能测试手册</span></a><button aria-label="Expand sidebar category &#x27;硬件性能测试手册&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/算力服务解决方案"><span title="算力服务解决方案" class="categoryLinkLabel_W154">算力服务解决方案</span></a><button aria-label="Expand sidebar category &#x27;算力服务解决方案&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/docs/category/开发者资源"><span title="开发者资源" class="categoryLinkLabel_W154">开发者资源</span></a><button aria-label="Expand sidebar category &#x27;开发者资源&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/推理软件使用手册"><span>推理软件使用手册</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/stcrp使用指南"><span>STCRP使用指南</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">MLTC使用指南</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>MLTC使用指南</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mltc概述">MLTC概述<a href="#mltc概述" class="hash-link" aria-label="Direct link to MLTC概述" title="Direct link to MLTC概述" translate="no">​</a></h2>
<p>MLTC（Multi-Level Tensor Compiler）是基于<a href="https://mlir.llvm.org/" target="_blank" rel="noopener noreferrer">MLIR</a>研发的端到端深度学习编译器，可以将来自不同框架的AI模型编译为适配硬件产品的可执行文件，同时加速AI模型的计算过程，提高系统的健壮性。</p>
<p>MLTC具有以下特性：</p>
<ul>
<li>
<p>通过多层IR设计实现逐层下降 ，解决代码生成的复杂性。每次IR层级的转换只专注代码生成的一个局部方面，例如多核执行模型、bufferization、算子逻辑的指令组合等。</p>
</li>
<li>
<p>提供一套算子无关的tiling系统，把一些算子的公共逻辑提升到编译器框架中，减轻算子编程的开发负担，提高系统的健壮性。面向NeuralScale架构编写算子时，不管是手写算子还是compute/schedule的DSL描述，其中大部分代码逻辑是管理多层存储结构和其间的数据传输。</p>
</li>
<li>
<p>性能优化以独立的优化pass形式作用在特定层级的IR上，可以任意打开或关闭，不影响系统健壮性。</p>
</li>
<li>
<p>保持图优化之后的编译器主干流程与算子无关，不存在任何针对特定算子的定制化逻辑。</p>
</li>
<li>
<p>保持图层IR算子的原子性，不包含可以由简单算子组合而成的复杂算子，没有融合算子。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提条件">前提条件<a href="#前提条件" class="hash-link" aria-label="Direct link to 前提条件" title="Direct link to 前提条件" translate="no">​</a></h2>
<p>准备好模型推理环境，安装HPE、MLTC、Python 3.10。具体操作，请参见<em>STCRP安装指南</em>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在npu上部署模型">在NPU上部署模型<a href="#在npu上部署模型" class="hash-link" aria-label="Direct link to 在NPU上部署模型" title="Direct link to 在NPU上部署模型" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tensorflow模型">TensorFlow模型<a href="#tensorflow模型" class="hash-link" aria-label="Direct link to TensorFlow模型" title="Direct link to TensorFlow模型" translate="no">​</a></h3>
<ol>
<li>
<p>调用MLTC的<code>TfToStc().run</code>接口解析AI框架导出的模型文件，转换为MLTC自定义的图层IR。接口需要指定输入输出文件路径，和输入节点。示例参考：</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TfToStc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;deepfm.pb&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deepfm_stc.mlir&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;feat_index:1024x39xi32,feat_value:1024x39xf32 -s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Sigmoid&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>调用MLTC的<code>Compiler().compile</code>接口编译模型，将转换得到的MLIR文件编译为在目标设备上部署的vmfb文件。接口需要指定输入输出文件路径，支持编译参数控制编译过程。</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Compiler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">compile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;deepfm_stc.mlir&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deepfm.vmfb&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-arch=npu-v1 --dump-ir-after-all&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>调用MLTC的<code>Executor().run()</code>接口部署模型，将编译得到的vmfb文件部署到NPU板卡上。接口需要指定输入的vmfb文件路径以及输入数据文件。</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Executor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;deepfm.vmfb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
</ol>
<blockquote>
<p>说明：具体Python接口定义请参见<em>Python</em> <em>API</em>。</p>
</blockquote>
<p>DeepFM模型部署模型示例：</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TfToStc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gen_fake_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_dtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> low</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> high</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FLOAT&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;float16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> high</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">tuple</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> input_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shapes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shapes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;feat_index&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">39</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shapes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;feat_value&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">39</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;int32,float32&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gen_fake_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./models/deepfm.pb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mlir_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./mlir_files/deepfm_stc.mlir&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 前端转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TfToStc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mlir_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;feat_index:1024x39xi32,feat_value:1024x39xf32&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Sigmoid&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deepfm.vmfb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compile_args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-arch=npu-v1 --dump-ir-after-all&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 编译模型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Compiler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">compile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mlir_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compile_args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 部署模型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Executor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=============== stc out ====================&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="onnx模型">ONNX模型<a href="#onnx模型" class="hash-link" aria-label="Direct link to ONNX模型" title="Direct link to ONNX模型" translate="no">​</a></h3>
<ol>
<li>
<p>调用MLTC的<code>OnnxToStc().run</code>接口解析AI框架导出的模型文件，转换为MLTC自定义的图层IR。接口需要指定输入输出文件路径，和输入节点。示例参考：</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OnnxToStc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;resnet18.onnx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;resnet18_stc.mlir&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-i input.1:1x3x224x224 -e&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>调用MLTC的<code>Compiler().compile</code>接口编译模型，将转换得到的MLIR文件编译为在目标设备上部署的vmfb文件。接口需要指定输入输出文件路径，支持编译参数控制编译过程。</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Compiler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">compile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;resnet18_stc.mlir&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;resnet18.vmfb&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-arch=npu-v1 --dump-ir-after-all&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>调用MLTC的<code>Executor().run()</code>接口部署模型，将编译得到的vmfb文件部署到NPU板卡上。接口需要指定输入的vmfb文件路径以及输入数据文件。</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Executor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;resnet18.vmfb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
</ol>
<blockquote>
<p>说明：具体Python接口定义请参见<em>Python</em> <em>API</em>。</p>
</blockquote>
<p>ResNet18模型部署模型示例：</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OnnxToStc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gen_fake_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_dtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> low</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> high</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;,&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FLOAT&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;float16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> high</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">tuple</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dtype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> input_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shapes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_shapes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input.1&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">224</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">224</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;float32&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gen_fake_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_shapes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./models/resnet18.onnx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mlir_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./mlir_files/resnet18_stc.mlir&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 前端转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OnnxToStc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">mlir_file </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-i input.1:1x3x224x224 -e&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;resnet18.vmfb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compile_args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-arch=npu-v1 --dump-ir-after-all&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 编译模型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Compiler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">compile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mlir_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compile_args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 部署模型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Executor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=============== stc out ====================&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pytorch模型">PyTorch模型<a href="#pytorch模型" class="hash-link" aria-label="Direct link to PyTorch模型" title="Direct link to PyTorch模型" translate="no">​</a></h3>
<p>调用<code>optimize</code>接口将AI框架导出的模型文件，转换为MLTC自定义的图层IR并编译部署。</p>
<blockquote>
<p>说明：具体Python接口定义请参见<em>Python</em> <em>API</em>。</p>
</blockquote>
<p>自定义小模型示例参考如下：</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mltc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mltc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frontend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">torch_frontend </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> optimize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@torch</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">library</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">custom_op</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mylib::numpy_sin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutates_args</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> schema</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;(Tensor x) -&gt; Tensor&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">numpy_sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_tensor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_np </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> input_tensor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_np </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros_like</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_np</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_np</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">output_np</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_numpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_np</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@numpy_sin</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">register_fake</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new_empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TestModule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mylib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numpy_sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aten</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestModule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch_out </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;torch output&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optimized_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optimize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__class__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_names</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_names</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;output0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;output1&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            op_black_list</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;mylib.numpy_sin.default&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            use_cache</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;torch_mltc&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mltc_out </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optimized_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimized_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__class__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mltc output&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mltc_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rtol</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e-2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> atol</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e-2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mltc_out</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> torch_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="故障排查">故障排查<a href="#故障排查" class="hash-link" aria-label="Direct link to 故障排查" title="Direct link to 故障排查" translate="no">​</a></h3>
<p>在NPU板卡上部署模型时，如果出现板卡运行异常的情况，如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-13-feed6f706aed0e714ecede8aebe8a9d8.png" width="906" height="227" class="img_ev3q"></p>
<p>图中提示mme或vme指令访存越界，引发异常的指令编码是0x06ABe8FB（图中红色标记部分）。以现有的报错信息无法确定具体是哪条指令的问题，需手动修改CC文件来确定具体指令，过程较为繁琐，因此我们提供了一个指令编码翻译脚本工具，可直接查询具体哪条指令导致的放存越界。</p>
<p>指令编码翻译脚本工具（inst_decoder.py）放在MLTC安装目录下的<code>tools</code>下。使用脚本解析报错的指令编码，得到指令编码对应的具体指令。</p>
<p>运行<code>inst_decoder.py</code>脚本，使用<code>--inst</code>参数传入异常指令编码：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python inst_decoder.py --inst 0x06ABe8FB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">isnt binary code: [&#x27;000001&#x27;, &#x27;1&#x27;, &#x27;01010&#x27;, &#x27;10111&#x27;, &#x27;1&#x27;, &#x27;10&#x27;, &#x27;10001&#x27;, &#x27;1111011&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inst asm: veadd.mv.dimw (x17), (x23), (x10)</span><br></span></code></pre></div></div>
<p>解析完成后直接输出编码对应的具体指令。其中<code>inst asm: veadd.mv.dimw (x17), (x23), (x10)</code>打印的是异常指令编码用到的是(x17)，(x23)，(x10)这三个指令， 根据上图中的显示信息，可得出不同指令的地址：x17=0xc0400000, x10=0xf8300000, x23=0xc0097f00，其中0xf8300000地址不在L1地址范围，可以得出x10中的地址为非法地址。</p>
<p>而<code>[&#x27;000001&#x27;, &#x27;1&#x27;, &#x27;01010&#x27;, &#x27;10111&#x27;, &#x27;1&#x27;, &#x27;10&#x27;, &#x27;10001&#x27;, &#x27;1111011&#x27;]</code>打印的是指令二进制编码8个字段信息，示例如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-12-8eb396e314a3975323707446ffc6a79e.png" width="1141" height="93" class="img_ev3q"></p>
<p>参数说明：</p>
<table><thead><tr><th><strong>参数选项</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>--inst</td><td>异常出错的指令编码。默认值为：0x06ABE8FB。</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在cpu上验证模型">在CPU上验证模型<a href="#在cpu上验证模型" class="hash-link" aria-label="Direct link to 在CPU上验证模型" title="Direct link to 在CPU上验证模型" translate="no">​</a></h2>
<p>以验证ResNet34模型为例，将通过MLTC前端转换后模型的MLIR部署到CPU上验证模型。</p>
<blockquote>
<p>说明：Python接口定义请参见<em>Python API</em>。</p>
</blockquote>
<ol>
<li>
<p>编写Python脚本，调用MLTC的<code>Simulator().run()</code>接口在CPU上部署模型，需要指定输入的mlir文件路径、运行参数，支持部署参数控制部署过程。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat run_resnet34_cpu.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from mltc import Simulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Simulator().run(&quot;resnet34.mlir&quot;, &quot;-i data_fp32.bin -o output.bin&quot;)</span><br></span></code></pre></div></div>
</li>
<li>
<p>执行Python脚本。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_resnet34_cpu.py</span><br></span></code></pre></div></div>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="推理效果演示">推理效果演示<a href="#推理效果演示" class="hash-link" aria-label="Direct link to 推理效果演示" title="Direct link to 推理效果演示" translate="no">​</a></h2>
<p>以YOLOv5模型为例，演示模型的编译部署，并查看NPU和CPU的推理效果，示例执行步骤如下：</p>
<ol>
<li>
<p>获取官方的YOLOv5镜像以及repo。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/ultralytics/yolov5.git</span><br></span></code></pre></div></div>
</li>
<li>
<p>从<a href="https://huggingface.co/fcakyon/yolov5s-v7.0/tree/main" target="_blank" rel="noopener noreferrer">HuggingFace</a>下载pt格式的权重（<code>yolov5s.pt</code>），并将权重文件移动到YOLOv5 repo所在的平级目录。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-14-7910f9f060d550270847e7671367ce78.png" width="1280" height="361" class="img_ev3q"></p>
</li>
<li>
<p>设置环境变量。</p>
<p>使用<code>PYTHONPATH</code>设置YOLOv5的repo路径。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export PYTHONPATH=~/yolov5</span><br></span></code></pre></div></div>
</li>
<li>
<p>在服务器环境中安装相关python组件。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ pip3 install torchvision==0.13.1 --index-url https://download.pytorch.org/whl/cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ pip3 install opencv-python</span><br></span></code></pre></div></div>
</li>
<li>
<p>使用官方脚本（<code>export.py</code>）将权重从pt格式转换为onnx格式。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd yolov5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 ./export.py --weights ../yolov5s.pt --include onnx --dynamic --opset 13</span><br></span></code></pre></div></div>
</li>
<li>
<p>验证ONNX模型在CPU上的执行效果。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 ./detect.py --weights ../yolov5s.onnx</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-11-2873d6ecb73f5804cc9c786f2c20fe0e.png" width="1280" height="194" class="img_ev3q"></p>
</li>
<li>
<p>您可以选择将ONNX模型的metadata导出到YAML文件中。</p>
<p>脚本示例如下：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> onnx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">onnx_model_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;../yolov5s.onnx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yaml_output_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;../yolov5s.metadata&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onnx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">onnx_model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> prop </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metadata_props</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">yaml_output_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;w&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> yaml_file</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    yaml</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metadata_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> yaml_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> default_flow_style</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>编写并执行脚本，将ONNX模型转换编译为vmfb格式文件。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat compile.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from mltc import OnnxToStc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from mltc import Compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_file = &quot;../yolov5s.mlir&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output_file = &quot;../yolov5s.vmfb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compile_args = &quot;-arch=npu-v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnnxToStc().run(&quot;../yolov5s.onnx&quot;, input_file, &quot;&quot;, &quot;-i images:1x3x640x640 -s -e&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compiler().compile(input_file, output_file, compile_args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 compile.py</span><br></span></code></pre></div></div>
</li>
<li>
<p>修改部分代码适配YOLOv5的repo。</p>
<ul>
<li>
<p>修改<code>models/common.py</code>，修改点如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git diff models/common.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/models/common.py b/models/common.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 341e878b..14c932be 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- a/models/common.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/models/common.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -477,7 +477,7 @@ class DetectMultiBackend(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         super().__init__()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         w = str(weights[0] if isinstance(weights, list) else weights)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-        pt, jit, onnx, xml, engine, coreml, saved_model, pb, tflite, edgetpu, tfjs, paddle, triton = self._model_type(w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        pt, jit, onnx, xml, engine, coreml, saved_model, pb, tflite, edgetpu, tfjs, paddle, vmfb, triton = self._model_type(w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         fp16 &amp;= pt or jit or onnx or engine or triton  # FP16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         nhwc = coreml or saved_model or pb or tflite or edgetpu  # BHWC formats (vs torch BCWH)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         stride = 32  # default stride</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -533,6 +533,9 @@ class DetectMultiBackend(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 batch_size = batch_dim.get_length()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ov_compiled_model = core.compile_model(ov_model, device_name=&quot;AUTO&quot;)  # AUTO selects best available device</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             stride, names = self._load_metadata(Path(w).with_suffix(&quot;.yaml&quot;))  # load metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        elif vmfb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            from mltc import Executor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            executor = Executor(w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         elif engine:  # TensorRT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             LOGGER.info(f&quot;Loading {w} for TensorRT inference...&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             import tensorrt as trt  # https://developer.nvidia.com/nvidia-tensorrt-download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -739,6 +742,17 @@ class DetectMultiBackend(nn.Module):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             self.input_handle.copy_from_cpu(im)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             self.predictor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             y = [self.predictor.get_output_handle(x).copy_to_cpu() for x in self.output_names]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        elif self.vmfb:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            def convert_dtype(type: str):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                if &quot;INT&quot; in type.upper():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                    return &quot;int32&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                return &quot;float16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            inputs = {&quot;images&quot;: im.cpu().numpy()}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            feeds = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            for key in inputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                feeds[key] = inputs[key].astype(convert_dtype(str(inputs[key].dtype)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            y = self.executor.run(feeds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+            y = torch.tensor(y[&quot;output0&quot;], dtype=torch.float32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         elif self.triton:  # NVIDIA Triton Inference Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             y = self.model(im)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         else:  # TensorFlow (SavedModel, GraphDef, Lite, Edge TPU)</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-8e57b7a49b1c050e85b6a2a27a3cb3e4.png" width="1021" height="676" class="img_ev3q"></p>
</li>
<li>
<p>修改<code>export.py</code>，修改点如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git diff export.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/export.py b/export.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 3ecb353b..ac3f654a 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- a/export.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/export.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -178,6 +178,7 @@ def export_formats():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         [&quot;TensorFlow Edge TPU&quot;, &quot;edgetpu&quot;, &quot;_edgetpu.tflite&quot;, False, False],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         [&quot;TensorFlow.js&quot;, &quot;tfjs&quot;, &quot;_web_model&quot;, False, False],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         [&quot;PaddlePaddle&quot;, &quot;paddle&quot;, &quot;_paddle_model&quot;, True, True],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        [&quot;STC MLTC fatbin&quot;, &quot;vmfb&quot;, &quot;.vmfb&quot;, False, True],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     return pd.DataFrame(x, columns=[&quot;Format&quot;, &quot;Argument&quot;, &quot;Suffix&quot;, &quot;CPU&quot;, &quot;GPU&quot;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-1-7811fc5234eb0a067362273618257662.png" width="788" height="198" class="img_ev3q"></p>
</li>
</ul>
</li>
<li>
<p>部署模型，验证模型在NPU上的执行效果。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 ./detect.py --weights ../yolov5s.vmfb --data ../yolov5s.metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 忽略部分显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Tue Feb 18 20:18:45 2025]  [stc_device.cc:70 ] &lt;getDevices&gt; &lt;WARNING&gt;  Current DEVICES: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">image 1/2 /root/yolov5/data/images/bus.jpg: 640x640 4 persons, 1 bus, 21.0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">image 2/2 /root/yolov5/data/images/zidane.jpg: 640x640 2 persons, 1 tie, 22.7ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Speed: 7.6ms pre-process, 21.8ms inference, 1.8ms NMS per image at shape (1, 3, 640, 640)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Results saved to runs/detect/exp9</span><br></span></code></pre></div></div>
</li>
</ol>
<p>生成的图片示例如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-2-91c3543b11a65b4ac482d460c5bc8cc3.png" width="810" height="1080" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-3-f9403b4e02b7762dfdf8b0593068ee3d.png" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析推理性能">分析推理性能<a href="#分析推理性能" class="hash-link" aria-label="Direct link to 分析推理性能" title="Direct link to 分析推理性能" translate="no">​</a></h2>
<p>使用性能分析工具可以快速分析性能问题。性能分析工具可获取整网中算子详细的性能信息，并详细显示图调度后算子每次运行的性能信息。</p>
<p>性能分析工具中主要包含获取性能数据脚本：<code>run_perf_analysis.py</code>，脚本放在MLTC安装目录下的<code>tools/dump_memory</code>下，可通过<code>mltc.__path__ </code>找到MLTC的安装路径。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Python 3.10.11 (main, May 16 2023, 00:28:57) [GCC 11.2.0] on linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt; import mltc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt; mltc.__path__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[&#x27;/root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls /root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc/tools/dump_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ci_compare.py  common.py  __init__.py  __pycache__  run_analysis.py  run_npu_data_analysis.py  run_perf_analysis.py  run_precision_analysis.py</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用限制">使用限制<a href="#使用限制" class="hash-link" aria-label="Direct link to 使用限制" title="Direct link to 使用限制" translate="no">​</a></h3>
<p>目前性能分析工具，不支持copy类算子及DMA cycle性能数据统计。具体支持的算子参见<em>MLTC算子支持说明</em>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行步骤">执行步骤<a href="#执行步骤" class="hash-link" aria-label="Direct link to 执行步骤" title="Direct link to 执行步骤" translate="no">​</a></h3>
<ol>
<li>
<p>设置环境变量。</p>
<p>使用<code>DUMP_PERF_PATH</code>设置性能数据dump后存放的目录，用于存放模型执行过程中的性能数据。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 设置性能数据存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_PERF_PATH=${perf_dir_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_PERF_PATH=~/perf_dump</span><br></span></code></pre></div></div>
</li>
<li>
<p>获取模型的性能数据。</p>
<p>运行需要性能分析的网络模型用例，具体示例可参考<em>使用示例章节</em>。</p>
</li>
<li>
<p>运行工具中的NPU数据分析脚本，获取节点每次运行的详细性能数据。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_perf_analysis.py</span><br></span></code></pre></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例">使用示例<a href="#使用示例" class="hash-link" aria-label="Direct link to 使用示例" title="Direct link to 使用示例" translate="no">​</a></h3>
<p>将以ResNet34网络为例，使用性能分析工具获取性能数据：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_PERF_PATH=~/perf_dump/resnet34_perf_dump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 compile_resnet34.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_resnet34.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd /root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc/tools/dump_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_perf_analysis.py</span><br></span></code></pre></div></div>
<p>最终对比结果生成在您指定的dump数据存放目录下，即设置的<code>DUMP_PERF_PATH</code>下，其中包含：</p>
<ul>
<li>
<p>dump_data文件夹：主要保存的是dump出来的16进制的数据。</p>
</li>
<li>
<p>result文件夹：主要保存的是最终对比分析结果。</p>
<ul>
<li>
<p><code>skip_perf_dict.csv</code>：执行过程中被跳过的节点以及详细跳过信息。</p>
</li>
<li>
<p><code>op_perf_{coreid}.csv</code>：每个核上的性能数据。</p>
</li>
</ul>
</li>
</ul>
<p>以<code>op_perf\_0.csv</code>性能数据为例，结果文件如下图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-4-1ab3d9bad839e326802c92325a497115.png" width="1280" height="432" class="img_ev3q"></p>
<p>字段说明：</p>
<table><thead><tr><th><strong>字段名</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>name</td><td>节点名称。</td></tr><tr><td>mcu_cycle</td><td>总的执行周期数。</td></tr><tr><td>vme_cycle</td><td>vme执行单元的周期数。</td></tr><tr><td>mme_cycle</td><td>mme执行单元的周期数。</td></tr><tr><td>vec_cycle</td><td>rvv执行单元的周期数。</td></tr><tr><td>syn_cycle</td><td>sync执行单元的周期数。</td></tr><tr><td>mte_total_cycle</td><td>mte总周期数。</td></tr><tr><td>vme_inst</td><td>vme指令条数。</td></tr><tr><td>mme_inst</td><td>mme指令条数。</td></tr><tr><td>vec_inst</td><td>rvv指令条数。</td></tr><tr><td>syn_inst</td><td>sync指令条数。</td></tr><tr><td>mte_pld_inst</td><td>pld指令条数。</td></tr><tr><td>mte_icmov_inst</td><td>icmov指令条数。</td></tr><tr><td>mte_mov_inst</td><td>mov指令条数。</td></tr><tr><td>pal_vme_mme_cycle</td><td>vme和mme指令并行运行周期数。</td></tr><tr><td>pal_mte_mme_cycle</td><td>vme和mme指令并行运行周期数。</td></tr><tr><td>pal_vme_mte_cycle</td><td>vme和mte指令并行运行周期数。</td></tr><tr><td>pal_total_cycle</td><td>vme、mme、mte总并行运行周期数。</td></tr><tr><td>mte_icmov_cycle</td><td>icmov指令周期数。</td></tr><tr><td>mte_l12llb_cycle</td><td>mov_l12llb指令周期数。</td></tr><tr><td>mte_llb2l1_cycle</td><td>mov_llb2l1指令周期数。</td></tr><tr><td>mte_pld_cycle</td><td>pld指令周期数。</td></tr><tr><td>mte_pld_byte</td><td>pld搬移的数据总量，字节为单位。</td></tr><tr><td>mte_l12llb_byte</td><td>mov_l12llb搬移的数据总量，字节为单位。</td></tr><tr><td>mte_llb2l1_byte</td><td>mov_llb2l1搬移的数据总量，字节为单位。</td></tr><tr><td>mte_icmov_byte</td><td>icmov搬移的数据总量，字节为单位。</td></tr><tr><td>syn_wait_cycle</td><td>syn等待的周期数。</td></tr><tr><td>vec_slot_wait_cycle</td><td>rvv指令等待执行的周期数。</td></tr><tr><td>mme_slot_wait_cycle</td><td>mme指令等待执行的周期数。</td></tr><tr><td>mte_slot_wait_cycle</td><td>mte指令等待执行的周期数。</td></tr><tr><td>l1_conflict_cycle</td><td>l1冲突周期数。</td></tr><tr><td>im_conflict_cycle</td><td>imb冲突周期数。</td></tr><tr><td>dcache_miss_cnt</td><td>dcache没命中次数。</td></tr><tr><td>icache_miss_cnt</td><td>icache没命中次数。</td></tr><tr><td>instruction_cnt</td><td>总指令条数。</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析精度">分析精度<a href="#分析精度" class="hash-link" aria-label="Direct link to 分析精度" title="Direct link to 分析精度" translate="no">​</a></h2>
<p>使用精度分析工具可以快速定位精度问题。精度分析工具可提供生成的网络模型在CPU与NPU运行的数据对比结果分析表，还提供精度对比失败算子的详细信息，包括精度对比失败发生位置的索引号以及在CPU和NPU上的索引位置的值。</p>
<p>精度分析工具中主要包含以下脚本:</p>
<ul>
<li>
<p><code>run_npu_data_analysis.py</code>：NPU数据拼接脚本。</p>
</li>
<li>
<p><code>run_precision_analysis.py</code>：NPU和CPU精度对比脚本。</p>
</li>
</ul>
<p>所有脚本放在MLTC安装目录下的<code>tools/dump_memory</code>下，可通过<code>mltc.__path__ </code>找到MLTC的安装路径。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Python 3.10.11 (main, May 16 2023, 00:28:57) [GCC 11.2.0] on linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt; import mltc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt; mltc.__path__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[&#x27;/root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls /root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc/tools/dump_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ci_compare.py  common.py  __init__.py  __pycache__  run_analysis.py  run_npu_data_analysis.py  run_perf_analysis.py  run_precision_analysis.py</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行步骤-1">执行步骤<a href="#执行步骤-1" class="hash-link" aria-label="Direct link to 执行步骤" title="Direct link to 执行步骤" translate="no">​</a></h3>
<ol>
<li>
<p>设置环境变量。</p>
<p>使用<code>DUMP_MEMORY_PATH</code>设置dump数据存放的目录，用于存放dump模型执行过程中的数据，基于dump数据分析出的NPU/CPU数据，以及精度对比结果。</p>
<blockquote>
<p>注意：该设置在运行时会影响cycle数，可通过<code>unset DUMP_MEMORY_PATH</code>删除环境变量设置。</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 设置dump数据存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_MEMORY_PATH=${dump_dir_name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_MEMORY_PATH=~/data_dump/test_1</span><br></span></code></pre></div></div>
<blockquote>
<p>注意：目标路径只能设置为<strong>绝对路径</strong>，且路径字符长度不超过50个字符。如果目标目录不存在，则会自动新建目录；如果目标目录已存在，则会自动<strong>删除</strong>整个目录后再自动新建。设置目录时，请多加注意。</p>
</blockquote>
</li>
<li>
<p>获取模型的NPU数据。</p>
<p>编译并运行需要精度分析的网络模型用例，dump出NPU数据存放在<code>$DUMP_MEMORY_PATH/dump_data</code>文件夹中对应卡的文件夹下，单卡情况下数据只会dump到0文件夹中。多卡情况下dump出来的数据会放在对应的文件夹下，下图以两卡为例，0，1文件夹下分别存放着0卡和1卡dump出来的数据。</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="253" height="156" class="img_ev3q"></p>
<blockquote>
<p>说明：具体模型示例可参考<em>使用示例章节</em>。</p>
</blockquote>
</li>
<li>
<p>获取模型的CPU数据。</p>
<p>编写Python脚本，调用MLTC的<code>Simulator().run()</code>接口在CPU上部署模型获取dump数据。</p>
<p>其中<code>--dump-dir</code>设置的路径为<code>DUMP_MEMORY_PATH</code>设置的目录下cpu文件夹路径并且为绝对路径。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat run_resnet34_cpu.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from mltc import Simulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Simulator().run(&quot;resnet34.mlir&quot;, &quot;-i data.bin -o output.bin --dump-each-op-result --dump-dir=/root/data_dump/test_1/cpu&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_resnet34_cpu.py</span><br></span></code></pre></div></div>
</li>
<li>
<p>运行工具中的NPU数据拼接脚本，对NPU数据进行拼接。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_npu_data_analysis.py</span><br></span></code></pre></div></div>
<p>运行后得到拼接后的NPU数据：</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="182" height="175" class="img_ev3q"></p>
</li>
<li>
<p>运行精度对比脚本，对比NPU和CPU数据。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_precision_analysis.py --ref_dtype=&quot;float32&quot;</span><br></span></code></pre></div></div>
<p>其中，<code>run_precision_analysis.py</code>脚本，运行时可传入不同参数，获取不同结果文件。您可以使用<code>-h，--help</code>查看帮助信息中的可选参数，其中<code>--atol</code>、<code>--rtol</code>可设置阈值、<code>--show_graph</code>可获取错误节点的分析图，其他参数值不建议修改。</p>
<p>可选参数说明：</p>
<table><thead><tr><th><strong>参数选项</strong></th><th><strong>描述</strong></th><th><strong>是否建议修改</strong></th></tr></thead><tbody><tr><td>-h，--help</td><td>显示帮助信息并退出。</td><td>/</td></tr><tr><td>--ref_dtype</td><td>模型输入数据类型。</td><td>是</td></tr><tr><td>--cpu_dir</td><td>CPU数据的存放目录。</td><td>否</td></tr><tr><td>--npu_dir</td><td>NPU数据的存放目录。</td><td>否</td></tr><tr><td>--node_runtime_filename</td><td>存放每个节点的运行时刻，主要用来排序。</td><td>否</td></tr><tr><td>-op_config_name</td><td>每个节点的比较时候用的atol和rtol，默认是NA表示用全局的atol/rtol。特殊需求时使用。</td><td>否</td></tr><tr><td>--diff_cnt</td><td>最大导出的出错数据个数，默认值为128。</td><td>否</td></tr><tr><td>--atol</td><td>绝对误差阈值，默认值为0.005。脚本会根据绝对误差阈值的设置来统计误差超过该阈值的结果在全部结果中的占比。</td><td>是</td></tr><tr><td>--rtol</td><td>相对误差阈值，默认值为0.2，范围在[0.0 ~ 1.0]。脚本会根据相对误差阈值的设置来统计误差超过该阈值的结果在全部结果中的占比。</td><td>是</td></tr><tr><td>--show_graph</td><td>是否显示所有错误节点的分析图，取值含义：<br>- True：显示分析图。如果数据量大，绘图会比较耗时。<br>- False：默认值，不显示分析图。<br>分析图包括以下类型：<br>- <code>{op_name}_diff.png</code> ：错误数据对应的绝对误差和相对误差散点图。<br>- <code>{op_name}_diff_hist.png</code> ： 相对误差和绝对误差的直方图分布。<br>- <code>{op_name}_hist.png</code>：CPU和NPU数据的直方图分布。</td><td>是</td></tr><tr><td>--max_bins</td><td>直方图最大bin数，默认值为128。</td><td>否</td></tr><tr><td>--min_bins</td><td>直方图最小bin数，默认值为1，范围为[1, max_bins]。</td><td>否</td></tr><tr><td>--max_cores</td><td>精度分析时用到最大核数，默认值为16。</td><td>否</td></tr><tr><td>--map_node_dict</td><td>人为给定的参考节点与NPU节点映射dict，内容示例 ：<code>&#x27;{&quot;cpu_name&quot;:&quot;npu_name&quot;,&quot;b&quot;:&quot;2&quot;}&#x27;</code>。映射关系唯一性和正确性需得到保证。</td><td>否</td></tr><tr><td>--force_compare</td><td>精度分析时，是否对shape不一致但size一致的节点进行分析，默认值为False。</td><td>否</td></tr></tbody></table>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用示例-1">使用示例<a href="#使用示例-1" class="hash-link" aria-label="Direct link to 使用示例" title="Direct link to 使用示例" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="获取精度">获取精度<a href="#获取精度" class="hash-link" aria-label="Direct link to 获取精度" title="Direct link to 获取精度" translate="no">​</a></h4>
<p>将以ResNet34网络为例，使用精度分析工具获取精度数据：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export DUMP_MEMORY_PATH=~/data_dump/test_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mltc-tf -i data:16x224x224x3xf32 -t softmax/Softmax -s resnet34/resnet34.pb -o resnet34/resnet34.mlir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 compile_resnet34.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_resnet34.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_resnet34_cpu.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd /root/miniconda3/envs/py310/lib/python3.10/site-packages/mltc/tools/dump_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_npu_data_analysis.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3 run_precision_analysis.py --ref_dtype=&quot;float32&quot;</span><br></span></code></pre></div></div>
<p>最终对比结果生成在您指定的dump数据存放目录下，即设置的<code>DUMP_MEMORY_PATH</code>下，其中包含：</p>
<ul>
<li>
<p>cpu文件夹：主要保存的是获取网络模型在CPU上的数据。数据文件是按照实际网络模型中的节点名称来命名，将名称中的 “/” 替换成 “_”。</p>
</li>
<li>
<p>dump_data文件夹：主要保存的是dump出来的16进制的数据。经过<code>run_npu_data_analysis.py</code>脚本转成二进制形式并进行数据拼接，最终输出到npu文件夹。</p>
</li>
<li>
<p>npu文件夹：主要保存的是获取网络模型在NPU上的数据，命名规则与cpu文件夹中一样。</p>
</li>
<li>
<p>result文件夹：主要保存的是最终对比分析结果。</p>
<ul>
<li>
<p><code>skip_file_dict.csv</code>：执行数据拼接前由于校验错误而被跳过的节点以及详细跳过信息。</p>
</li>
<li>
<p><code>compare_skip.log</code>：执行CPU和NPU数据比对时被跳过的节点以及详细跳过信息。</p>
</li>
<li>
<p><code>cpu_vs_npu.csv</code>：CPU和NPU数据比较结果分析表。</p>
</li>
<li>
<p><code>node_runtime.file</code>：节点运行时序文件。</p>
</li>
<li>
<p><code>md5.csv</code>：记录每个dump文件的md5值。</p>
</li>
<li>
<p><code>{op_name}.csv</code>：以算子名称命名的错误算子的详细错误信息。</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>说明：结果文件具体说明可查看结果文件说明<em>章节</em>。</p>
</blockquote>
<p>若<code>--show_grap</code>设为<code>True</code>，则在result文件夹下还会显示以算子名称命名的错误算子的分析图：</p>
<ul>
<li>
<p><code>{op_name}_diff.png</code>：错误节点对应的绝对误差和相对误差散点图。</p>
</li>
<li>
<p><code>{op_name}_diff_hist.png</code>：相对误差和绝对误差的直方图分布。</p>
</li>
<li>
<p><code>{op_name}_hist.png</code>：CPU和NPU数据的直方图分布。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分析结果">分析结果<a href="#分析结果" class="hash-link" aria-label="Direct link to 分析结果" title="Direct link to 分析结果" translate="no">​</a></h4>
<p>按照上述步骤获取精度后，分析误差节点的精度问题。</p>
<p>查看cpu_vs_npu.csv表中的节点误差。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-7-41f1f0ca444ead7d2935710bd18c8dd4.png" width="1280" height="411" class="img_ev3q"></p>
<p>主要查看nan/inf、errors/total和cos_sim三列，分析精度问题：</p>
<ul>
<li>
<p>nan/inf列有数据显示True，说明出现过NaN或inf数据，可能存在精度问题。</p>
</li>
<li>
<p>errors/total列不满足用户设置的相对误差和绝对误差的个数占比太大，可能存在现精度问题。</p>
</li>
<li>
<p>cos_sim列数值小于0.95，可能存在精度问题。</p>
</li>
</ul>
<blockquote>
<p>说明：每一列数据的具体说明可查看<em>结果文件说明</em>章节。</p>
</blockquote>
<p>若遇到csv文件中无法显示完整的大批量错误数据并且是按照index排列，无法确定哪一个节点误差较大。可自行对比cpu文件夹与npu文件夹中的数据文件，分析精度误差的原因。</p>
<blockquote>
<p>注意：网络模型在cpu和npu上的数据格式，数据格式可能存在NHWC或NCHW。对比时如果CPU与NPU上的数据格式不一致，需要先使用transpose函数改变数据排布。</p>
</blockquote>
<p>此外，若<code>--show_grap</code>设为<code>True</code>，可查看精度对比失败节点的分析图。</p>
<ul>
<li>
<p>错误节点对应的绝对误差和相对误差散点图（<code>{op_name}_diff.png</code>）：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-8-1374204d2c3bed5ed88d7b69c06c93d8.png" width="952" height="547" class="img_ev3q"></p>
</li>
<li>
<p>CPU和NPU数据的直方图分布（<code>{op_name}_hist.png</code>）：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-9-12ada71be00b7177f16ee8ac32b3bb04.png" width="897" height="514" class="img_ev3q"></p>
</li>
<li>
<p>相对误差和绝对误差的直方图分布（<code>{op_name}_diff_hist.png</code>）：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-10-44f0cb9ff41c9e5d188232364144f3e0.png" width="894" height="510" class="img_ev3q"></p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="结果文件说明">结果文件说明<a href="#结果文件说明" class="hash-link" aria-label="Direct link to 结果文件说明" title="Direct link to 结果文件说明" translate="no">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="cpu_vs_npucsv">cpu_vs_npu.csv<a href="#cpu_vs_npucsv" class="hash-link" aria-label="Direct link to cpu_vs_npu.csv" title="Direct link to cpu_vs_npu.csv" translate="no">​</a></h5>
<p>文件描述：最终的精度对比分析结果文件。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-15-e0917bf4acc9dff5326fc74a2072fc5f.png" width="1280" height="233" class="img_ev3q"></p>
<p>字段说明：</p>
<table><thead><tr><th><strong>字段名</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>op_name</td><td>网络中节点的名称（附带显示atol/rtol参数值）。</td></tr><tr><td>nan/inf</td><td>NPU结果数据中是否出现过nan或inf数据（比较前nan会被转成0，inf会被转成最大值）。</td></tr><tr><td>errors/total</td><td>不满足用户设置的相对误差和绝对误差的个数/当前算子的总个数（单位：个）。</td></tr><tr><td>cos_sim</td><td>NPU结果和CPU结果的余弦相似度，数据越大越好。</td></tr><tr><td>1st_diff_offset/offset_dim/data_shape</td><td>第一个数据错误的位置，对应的维度信息，数据shape信息。</td></tr><tr><td>ref_value</td><td>标准模型（TensorFlow模型、ONNX模型）第一个发生错误时的数据（目前仅保留小数点后6位有效数字），若当前算子均未发生精度对比失败，此时的值为算子输出的第一个数据。</td></tr><tr><td>npu_value</td><td>基于九章NPU框架的推理模型，第一个发生错误时的数据（目前仅保留小数点后6位有效数字），若当前算子均未发生精度对比失败，此时的值为算子输出的第一个数据。</td></tr><tr><td>max_abs_err</td><td>节点错误数据的最大绝对误差。</td></tr><tr><td>mean_abs_err</td><td>节点错误数据的平均绝对误差。</td></tr><tr><td>max_abs_total</td><td>节点数据的最大相对误差。</td></tr><tr><td>mean_abs_total</td><td>节点数据的平均相对误差。</td></tr><tr><td>mean</td><td>参考数据（TensorFlow模型、ONNX模型的数据）的均值。</td></tr><tr><td>std</td><td>参考数据（TensorFlow模型、ONNX模型的数据）的方差。</td></tr><tr><td>rms</td><td>参考数据（TensorFlow模型、ONNX模型的数据）的均方根值（root mean square）。</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="op_namecsv"><code>{op_name}.csv</code><a href="#op_namecsv" class="hash-link" aria-label="Direct link to op_namecsv" title="Direct link to op_namecsv" translate="no">​</a></h5>
<p>文件描述：精度对比失败算子详细信息。</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="419" height="158" class="img_ev3q"></p>
<p>字段说明：</p>
<table><thead><tr><th><strong>字段名</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>index</td><td>精度对比失败发生的索引号。</td></tr><tr><td>std_value</td><td>标准模型相应索引位置的值。</td></tr><tr><td>npu_value</td><td>九章NPU模型相应索引位置的值。</td></tr><tr><td>abs_diff</td><td>绝对误差。</td></tr><tr><td>relative_diff</td><td>相对误差。</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="误差类型及判断方法">误差类型及判断方法<a href="#误差类型及判断方法" class="hash-link" aria-label="Direct link to 误差类型及判断方法" title="Direct link to 误差类型及判断方法" translate="no">​</a></h4>
<p>NPU每个节点计算输出的误差可以分为两类：</p>
<ul>
<li>
<p>计算错误：由硬件或软件Bug问题导致的错误。</p>
</li>
<li>
<p>累积精度误差：由于在NPU上采用FP16计算，相对于CPU上使用FP32计算存在精度损失，并且这个精度损失逐层累积造成的误差。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="其他精度问题">其他精度问题<a href="#其他精度问题" class="hash-link" aria-label="Direct link to 其他精度问题" title="Direct link to 其他精度问题" translate="no">​</a></h4>
<ul>
<li>
<p>CPU与NPU输出结果均存在NaN。</p>
<p>当发现CPU与NPU运行出来的结果都存在NaN的问题时，可考虑网络模型本身的问题，可能存在模型中算子的参数不合法的情况。</p>
</li>
<li>
<p>可能是算子参数为inf，使得与其他数字相乘会出错，导致结果都是NaN，此时应考虑算子问题。</p>
</li>
<li>
<p>可能是模型输入不合适，例如输入中包含负数，而网络模型中存在Log这一类的算子，经过该节点是会出现计算错误，使得CPU和NPU的运行结果为NaN。</p>
</li>
<li>
<p>CPU输出正常而NPU结果为NaN。</p>
<p>当发现CPU的输出正常而NPU运行出来的结果为NaN的问题时，可考虑是算子参数导致，其表现是中间输出结果超FP16范围（65504），通常两个大数相乘或者除以一个极小的数时容易出现结果超出FP16范围问题（65504）。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="精度分析定位技巧">精度分析定位技巧<a href="#精度分析定位技巧" class="hash-link" aria-label="Direct link to 精度分析定位技巧" title="Direct link to 精度分析定位技巧" translate="no">​</a></h4>
<ul>
<li>
<p>随机精度问题定位</p>
<p>如果网络存在随机精度问题且在打开Dump Memory功能时也存在随机问题的情况下，可以用以下方法定位：</p>
<p>将模型网络运行两遍，数据分别dump在两个不同的路径下，然后分别运行<code>run_npu_data_analysis.py</code>脚本，在脚本运行过程中，运行完下图中第一个进度条后就可停止，工具会计算每个dump文件的md5并记录在<code>result/md5.csv</code>文件中。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-17-816fa08ca6c5816c3b480ecb3e32f262.png" width="1280" height="119" class="img_ev3q"></p>
<p>比较两个dump路径下的<code>result/md5.csv</code>文件就能知道那个节点的输出存在随机问题。</p>
<p>此外可以观察md5值是否是变化，来判断网络是否存在随机精度问题。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-18-9e543f0e35dd7c86f39f975a1c0f9472.png" width="1280" height="119" class="img_ev3q"></p>
</li>
<li>
<p>不跑stc-run进行精度分析</p>
<p>在修改过程中可能会引入一些问题导致之前精度正确的网络出现精度错误问题，则可以通过以下方法加速定位：</p>
<ol>
<li>
<p>分别获取精度正确和精度错误的网络的NPU上的数据，dump数据后使用<code>run_npu_data_analysis.py</code>脚本完成数据拼接。</p>
</li>
<li>
<p>将精度正确的网络Dump出来的放在npu文件夹下的所有NPU数据文件，拷贝到精度错误网络的cpu文件夹下，作为参考数据进行对比。</p>
</li>
<li>
<p>使用<code>run_precision_analysis.py</code>脚本对比数据。</p>
</li>
</ol>
<p>相比跑stc-run的优势在于，参考结果也是由NPU运行获取的，精度对比数据差异几乎没有，进而避免了查看精度分析结果时考虑FP16累加引入的不确定性。</p>
</li>
<li>
<p>出现精度问题时，可以考虑查看<code>STC_SET_DEVICES</code>指定的Cluster数。</p>
<p>首根轴会根据Cluster数进行切分补Pad操作，但部分模型或算子不可切分，切分后会出现精度问题。所以若模型无batch或者batch轴不可切分的情况，可尝试使用<code>STC_SET_DEVICES</code>指定单个Cluster进行运行部署。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="常见问题">常见问题<a href="#常见问题" class="hash-link" aria-label="Direct link to 常见问题" title="Direct link to 常见问题" translate="no">​</a></h3>
<ul>
<li>
<p>stc-run运行失败问题</p>
<p>目前stc-run支持的算子及支持的数据类型并不完善，在跑stc-run时可能遇到folder失败问题，正在完善修复中。</p>
</li>
<li>
<p>重复/丢失节点问题</p>
<ul>
<li>
<p>重复节点问题：</p>
<p>PASS在Span传递过程中各种原因导致Span重名问题，导致dump出来的节点名称出现重复的现象，工具在分析过程中会报以下错误：</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-19-d546f7f07e73eff5b691a6607563dc86.png" width="764" height="275" class="img_ev3q"></p>
<ul>
<li>
<p>丢失节点问题：</p>
<p>节点名重复导致信息不一致，会出现节点丢失的现象，工具在分析过程中中会报以下错误：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-20-0a9eabc74e050be55111277b15014e92.png" width="629" height="124" class="img_ev3q"></p>
</li>
</ul>
<p>上述两个节点问题的错误日志会记录在<code>result/skip_file_dict.csv</code>，如下所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-21-ab2df3c05b4e7a4ebea0c40d2bae3eb8.png" width="1044" height="80" class="img_ev3q"></p>
</li>
<li>
<p>多轮运行导致伪重复节点问题</p>
<p>在获取大模型数据时只能跑单轮，多轮运行会导致Span重复问题。查看数据如何区分是不是多轮dump导致，可以通过以下方式，如果文件数多于1个，说明是跑多轮导致。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls dump_data/0/0_map_name@0.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dump_data/0/0_map_name@0.011fda60_000001d2.dat dump_data/0/0_map_name@0.013fda60_000001d2.dat</span><br></span></code></pre></div></div>
</li>
<li>
<p>不支持dump的算子</p>
<p>数据拷贝类算子暂不支持dump功能，例如slice/concat/split等算子。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="生成量化模型">生成量化模型<a href="#生成量化模型" class="hash-link" aria-label="Direct link to 生成量化模型" title="Direct link to 生成量化模型" translate="no">​</a></h2>
<p>SNQ量化工具可以对小模型进行PTQ量化，量化工具能够直接支持的模型格式有ONNX、CAFFE，其他模型格式需先转成ONNX。若有PyTorch大模型量化需求，可选择使用SNC量化工具，详情可参见STC_LLM使用指南。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/mltc-image-22-a3244106bae7118a61872967bba91aef.png" width="674" height="432" class="img_ev3q"></p>
<blockquote>
<p>说明：如果在GPU上使用工具，请安装CUDA 11.8版本、CUDA驱动（cuda-repo-ubuntu2004-12-1-local_12.1.0-530.30.02-1_amd64.deb）以及显卡。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="执行步骤-2">执行步骤<a href="#执行步骤-2" class="hash-link" aria-label="Direct link to 执行步骤" title="Direct link to 执行步骤" translate="no">​</a></h3>
<p>以Bert128模型为例演示执行步骤：</p>
<ol>
<li>
<p>配置YAML文件。</p>
<p>根据网络的不同填写模型运行的基本参数，如果模型不是ONNX格式的需要做模型转换，内部提供了pb与pth模型的转化。量化策略与精度校准可以根据模型验证结果自行调节，找到合适当前网络的策略。</p>
<p>以下是Bert128模型的YAML文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 模型运行基本参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_name: &quot;bert_128&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local_model_path: &quot;./bert_128_tf.onnx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_name: [&quot;embedding_lookup:0&quot;,&quot;input_mask:0&quot;,&quot;one_hot:0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_shape: [[1024,768],[8,1,128],[1024,2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_dtype: [&quot;torch.float32&quot;, &quot;torch.float32&quot;, &quot;torch.float32&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">batch_size: 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output_node: &quot;loss/Softmax:0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 模型转为onnx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 是否需要转化为ONNX模型，True：若输入模型不是onnx,需要转换 False：不需要转换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">is_translate: False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 提供两种模型的转换：pb, pth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_type: &quot;onnx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">onnx_target_file: &quot;./bert_128.onnx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 模型输入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输入是否已经经过预处理，True: 已经过预处理，可从本地直接读取， False: 未经过预处理，需要添加预处理函数，返回模型输入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_preprocess: False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 已预处理后的数据，可以直接输入模型运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 提供两种文件读取：npy, bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 默认文件命名格式：file_path+file_name+index+file_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#                 ./bert128_datasets/embedding_look_up_0.npy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dataset:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      file_type: &quot;npy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      file_path: &quot;./bert128_dataset/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      file_name: [&quot;embedding_lookup_&quot;,&quot;input_mask_&quot;,&quot;one_hot_&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 未预处理的数据，请修改预处理脚本文件，提供校准数据，8-256组即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># def pre_process(config:dict, data_num:int) -&gt; List[{inputname_0:tensor,inputname_1:tensor},...]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 预处理脚本文件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre_process: &quot;pre_process&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">file_list: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 量化策略, 目前在NPUv1上可以改动的有限 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 量化总开关 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_quantize: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_file: &quot;./bert128_quant.onnx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 参数可选项：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        calibrate: kl, minmax, percentile, mse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        round: ROUND_TOWARDS_ZERO, ROUND_HALF_EVEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        policy: PerTensor, PerChannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        # 按照哪个轴做per_channel 开启PerChannel时需要指定，PerTensor不可包含这条属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        channel_axis: -2, -1, 0, 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#        Symmetric: true, false(open asymmetric)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conv:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  activation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calibrate: &quot;kl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    round: &quot;ROUND_TOWARDS_ZERO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: &quot;PerTensor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Symmetric: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parameter:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calibrate: &quot;minmax&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    round: &quot;ROUND_HALF_EVEN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: &quot;PerChannel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Symmetric: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel_axis: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">matmul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  activation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calibrate: &quot;kl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    round: &quot;ROUND_TOWARDS_ZERO&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: &quot;PerTensor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Symmetric: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parameter:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calibrate: &quot;minmax&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    round: &quot;ROUND_HALF_EVEN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy: &quot;PerChannel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Symmetric: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel_axis: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 量化精度校准选项，不改变量化策略的情况下，主要通过关闭量化误差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 较大的算子来提高精度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 总开关————是否开启关闭算子来提高量化精度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close_op: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关闭误差最大的算子数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close_op_num: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关闭量化精度小于阈值的所有算子，close_op_num为0时生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close_value: 0.999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关闭指定算子，填入算子名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close_op_name: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 寻找最优激活校准方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">activate_calib_algo: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 模型精度验证方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ----------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># SNQ验证模型精度标志，开启时不进行激活函数————gelu融合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_flag: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 验证模型精度脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># def quantonnxrun(config:dict):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 验证模型精度脚本文件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_run: test_run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 验证数据组数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test_num: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">atol: 0.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rtol: 0.01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 模型运行设备（cpu、cuda）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">device: cpu</span><br></span></code></pre></div></div>
<p>输入数据如果未经过预处理，需要添加预处理函数，并在YAML文件中标明预处理脚本。Bert128的预处理脚本可参考代码示例中的<code>pre_process.py</code>。已经做好了预处理的数据不一定适合所有场景，所以为了量化效果更加完善，建议用户选取自己需要的校准集来进行网络量化。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 输入是否已经经过预处理，true: 已经过预处理，可从本地直接读取， False: 未经过预处理，需要添加预处理函数，返回模型输入数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">input_preprocess</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 已预处理后的数据，可以直接输入模型运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 提供两种文件读取：npy, bin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 默认文件命名格式：file_path+file_name+index+file_type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#                 ./bert128_datasets/embedding_look_up_0.npy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dataset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">file_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;npy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">file_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./bert128_dataset/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">file_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;embedding_lookup_&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;input_mask_&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;one_hot_&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 未预处理的数据，请修改预处理脚本文件，提供校准数据，8-256组即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># def pre_process(config:dict, data_num:int) -&gt; List[{inputname_0:tensor,inputname_1:tensor},...]:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 预处理脚本文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pre_process</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pre_process&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">file_list</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>对精度有要求的模型，可接入结构的后处理，添加结果对比代码，并在YAML文件中标明预处理脚本。Bert128的验证模型精度脚本可参考代码示例中的<code>test_tun.py</code>。</p>
<p>原始模型与量化后的模型都会运行，可对它们的结果进行比较，得到精度对比结果。不同网络的验证模型精度脚本需要根据用户自己对网络的结果评判标准自己构建代码。</p>
<blockquote>
<p>说明：测试模块使用的是ONNX Runtime运行，不能含有ONNX Runtime无法运行的算子。</p>
</blockquote>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ----------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 模型精度验证方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ----------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SNQ验证模型精度标志，开启时不进行激活函数————gelu融合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">test_flag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证模型精度脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># def quantonnxrun(config:dict):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证模型精度脚本文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">test_run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test_run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证数据组数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">test_num</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">atol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rtol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><br></span></code></pre></div></div>
<blockquote>
<p>说明：配置的YMAL文件、数据预处理脚本和验证精度脚本需放在同一目录下。</p>
</blockquote>
</li>
<li>
<p>启动量化命令，生成量化后模型和模型参数。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd bert128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bert128_dataset  bert_128_tf.onnx  default_config.yaml  pre_process.py  test_run.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ auto_quant --config default_config.yaml</span><br></span></code></pre></div></div>
<ol>
<li>将量化后的模型和分离的模型参数一起放到NPU上使用MLTC编译运行。具体编译运行方式可参考在NPU上部署模型章节。</li>
</ol>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码示例">代码示例<a href="#代码示例" class="hash-link" aria-label="Direct link to 代码示例" title="Direct link to 代码示例" translate="no">​</a></h3>
<p>Bert128模型预处理脚本（pre_process.py），请自行准备好Bert128的数据集和Bert128的ONNX模型。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> minio </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Minio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> stcnq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utilities</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pull_from_minio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pre_process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data_num</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;model preprocessed data</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        filelist (list, optional): input file list. Defaults to [].</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        data_num (int, optional): output data number.  Return the number of date.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        dict: model input data</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># code ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    current_dir </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;local_model_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BATCH_SIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data_num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INPUT_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_type&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;npy&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                INPUT_NAME</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_numpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.npy&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INPUT_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BATCH_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_type&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bin&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                INPUT_NAME</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.bin&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">INPUT_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BATCH_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;not support data  file type&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;result type</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        result = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                &quot;input_name1&quot;: data1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                &quot;input_name2&quot;: data2</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                &quot;input_name1&quot;: data3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                &quot;input_name2&quot;: data4</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            },...</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    data type-----&gt; tensor of torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input_preprocess&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Bert128模型验证精度脚本（test_run.py）</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> onnxruntime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> importlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">functional </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Fun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> matplotlib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pyplot </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> plt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> atol</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.005</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rtol</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> accumulate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;compare&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> RuntimeError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;result length:</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">result</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> is not equal to gold data length: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">ref</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">atol</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> atol </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> accumulate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rtol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rtol </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">accumulate </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># print(f&quot;Comparing result using atol={atol}, rtol={rtol}&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result_int </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result_int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;int16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ref_int </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ref_int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;int16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mismatch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_abs_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    abs_diff_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rel_diff_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all_mismatch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abs_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ref</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ref_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abs_diff_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">abs_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rel_diff_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> abs_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> max_abs_diff</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_abs_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> abs_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> rel_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> max_rel_diff</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rel_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> abs_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> atol </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rel_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rtol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            all_mismatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> abs_diff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mismatch </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># if len(abs_diff_list) &gt; 0:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     print(&quot;mean absolute diff: {}&quot;.format(sum(abs_diff_list) / len(abs_diff_list)))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># else:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     print(&quot;mean absolute diff: 0.0&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># if len(rel_diff_list) &gt; 0:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     print(&quot;mean relative diff: {}&quot;.format(sum(rel_diff_list) / len(rel_diff_list)))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># else:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     print(&quot;mean relative diff: 0.0&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mismatch </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># print(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;Failed: {mismatch}/{len(result)} mismatch,&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;max absolute diff: {max_abs_diff}, max relative diff: {max_rel_diff}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mismatch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">show_mismatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mismatches </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sorted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">all_mismatch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> mismatches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># print(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;{msg} mismatch: out[{i}] = {result[i]}({result_int[i]}),&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;ref[{i}] = {ref[i]}({ref_int[i]}), atol={item[1]}, rtol={item[2]}&quot;,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">#     flush=True,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># print(f&quot;\n---------- top {n} max abs mismatches ----------&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        show_mismatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;abs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># print(f&quot;\n---------- top {n} max rel mismatches ----------&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        show_mismatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rel&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># print(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;Success: {mismatch}/{len(result)} mismatch,&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#     f&quot;max absolute diff: {max_abs_diff}, max relative diff: {max_rel_diff}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># )</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># print(&quot;Succeed&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">result_process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> label_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tf_position_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tf_prob_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loadtxt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">label_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loadtxt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./model_zoo/quant_argmax.txt&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc_prob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loadtxt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./model_zoo/quant_prob.txt&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loadtxt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_position_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tf_prob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loadtxt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    equal_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> label</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            equal_size </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tc true_label_accuracy: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    equal_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> label</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            equal_size </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tf true_label_accuracy: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># tf_label_accuracy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    equal_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> tc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            equal_size </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tf_label_accuracy: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> equal_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># max_abs_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    abs_diff_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cur_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> tc_prob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abs_diff_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total_diff </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> cur_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cur_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> max_diff</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cur_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;max_abs_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># mean_abs_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mean_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> total_diff </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> test_num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mean_abs_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">abs_diff_list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bins</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> density</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> histtype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Histogram of absolute error, samples 10570&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">savefig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cmp.png&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># std_abs_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    acc_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cur_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> tc_prob</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> mean_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> mean_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acc_diff </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> std_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;std_abs_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># max_rel_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tf_prob_int </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tf_prob_int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;int16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc_prob_int </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tc_prob</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tc_prob_int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;int16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cur_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tc_prob_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total_rel_diff </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> cur_rel_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cur_rel_diff </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> max_rel_diff</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cur_rel_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;max_rel_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># mean_rel_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mean_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> total_rel_diff </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> test_num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mean_rel_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean_rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># std _rel_diff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    acc_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cur_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf_prob_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tc_prob_int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std_rel_diff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_rel_diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> mean_rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cur_rel_diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> mean_rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acc_rel_diff </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> std_rel_diff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;std_rel_diff: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">acc_rel_diff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">quantonnxrun</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pre_process&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> importlib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">import_module</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pre_process </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pre_process&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    test_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;test_num&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;input_preprocess&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_type&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;npy&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    input_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.npy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_type&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bin&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    input_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;dataset&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;file_name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.bin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;not support data  file type&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pre_process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_tensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> TypeError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;data type is not torch&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dataset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">input_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onnx_run </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onnxruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InferenceSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;local_model_path&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> providers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">onnxruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_available_providers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onnx_outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">onnx_run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;output_node&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quant_run </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onnxruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InferenceSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;target_file&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> providers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">onnxruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_available_providers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quant_outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">quant_run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;output_node&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataset</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># you can modify the following code to achieve accuracy comparison</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pass_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pos_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        golden </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onnx_outputs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        quant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> quant_outputs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        position_quant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        position_golden </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">golden</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quant</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> golden</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> atol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;atol&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rtol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;rtol&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pass_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> position_golden</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> position_quant</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pos_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;quant::&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quant</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;golden::&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> golden</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pass_count:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pass_count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\t pass_rate:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%.2f%%&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pass_count </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;position_count:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos_count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\t pass_rate:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%.2f%%&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_count </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> test_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="图分组性能调优">图分组性能调优<a href="#图分组性能调优" class="hash-link" aria-label="Direct link to 图分组性能调优" title="Direct link to 图分组性能调优" translate="no">​</a></h2>
<p>为解决部分模型因自动分组导致的性能不佳问题，我们开发了手动图分组工具。该工具允许用户在MLTC编译过程中，通过提供图分组配置文件，指导编译器执行特定的分组切分操作。Manual Group Partition功能通过手动配置<code>--manual-partition-file</code>编译选项的方式指导MLTC对模型进行优化，具体涵盖 group切分、LLB切分、多核切分与L1切分。</p>
<div class="language-Bash language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> Compiler().compile(input_file, output_file, &quot;-arch=npu-v1 --manual-partition-file=/home/resnet50.yml&quot;)</span><br></span></code></pre></div></div>
<p>以ResNet50量化模型为例，演示手动图分组工具的操作步骤：</p>
<ol>
<li>
<p>获取可视化IR。</p>
<p>在进行手动Group Partition前需一份可视化的IR，该IR不能直接使用原始模型的IR，原因在于编译过程会做一些算子拆分、替换等操作，这些操作会引起IR中的span发生变化进而导致group切分的span无法对应。可通过运行<code>slim.py</code>脚本获取正确的可视化IR。</p>
<div class="language-Bash language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ python slim.py --mlir_path /root/stcrp190/script/mlir_files/resnet50.mlir --out_path /root/stcrp190/script/resnet50_view.mlir</span><br></span></code></pre></div></div>
<p>其中脚本放在MLTC安装目录下的<code>tools</code>下，可通过<code>mltc.__path__ </code>找到MLTC的安装路径。</p>
<p>可选参数说明：</p>
<table><thead><tr><th><strong>参数选项</strong></th><th><strong>描述</strong></th><th><strong>是否必选</strong></th></tr></thead><tbody><tr><td>--mlir_path</td><td>模型原始的MLIR的完整路径。</td><td>是</td></tr><tr><td>--out_path</td><td>可视化MLIR输出的完整路径。</td><td>是</td></tr><tr><td>--max_cores</td><td>处理过程中使用的最大线程数。</td><td>否</td></tr></tbody></table>
<p>脚本会dump出group partition前一个IR作为待处理的中间IR。对该中间IR做如下处理后输出可视化IR：</p>
<ol>
<li>
<p>将const value全部显示成<code>value = dense_resource&lt;__elided__&gt;</code>以减少可视化MLIR文件大小。</p>
</li>
<li>
<p>只保留可视化需要的span attr。</p>
</li>
<li>
<p>删除和替换Netron不支持的信息。例如，删除<code>builtin.module</code>信息；将<code>func.func&quot;()</code>替换成<code>&quot;func.func&quot;@NPUKernelFunc() {</code>等。</p>
</li>
</ol>
</li>
<li>
<p>使用Netron工具打开可视化IR，根据可视化IR性能调优。group是一个多输入、单输出的DAG，可以描述整个计算图中的一个子图。图分组切分只针对group。</p>
</li>
<li>
<p>配置YAML文件进行手动图分组。</p>
<p>配置文件字段包含：</p>
<ul>
<li>
<p>一级字段</p>
<table><thead><tr><th>字段名</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>groups</td><td><code>Array{Group}</code></td><td>包含所有分组信息的标志。</td></tr></tbody></table>
</li>
<li>
<p>二级字段</p>
<p>Group用以描述具体的分组信息，从属于一级字段groups。</p>
<table><thead><tr><th>字段名</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>inputs</td><td><code>Array{String}</code></td><td>输入节点的span name。</td></tr><tr><td>output</td><td><code>String</code></td><td>输出节点的span name。</td></tr><tr><td>split_axis</td><td><code>Array{int64_t}</code></td><td>当前group的切分轴。</td></tr><tr><td>split_factor</td><td><code>Array{int64_t}</code></td><td>当前group的切分份数。</td></tr></tbody></table>
</li>
</ul>
<p>配置文件要求：</p>
<ul>
<li>配置文件路径必须有效且可访问。</li>
<li>配置文件必须包含 <code>groups</code> 字段。</li>
<li>每个 group 必须包含<code>inputs</code>、<code>output</code>、<code>split_axis</code>、<code>split_factor</code>二级字段。</li>
<li><code>split_axis</code> 与 <code>split_factor</code> 字段的长度必须相同。</li>
<li><code>inputs</code> 字段中的span name必须是有效的。</li>
<li><code>output</code> 字段中的span name必须是有效的。</li>
<li>不同 group 的<code>output</code>字段值不能重复。</li>
<li><code>inputs</code> 中的每个span name必须是某个group的 <code>output</code>，或block argument的<code>user</code>。</li>
</ul>
<p>配置文件示例：</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Array&lt;Group&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Group 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bn_data_FusedBatchNorm_1_mul_4/0&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_24_quantize_0/47&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_axes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_factors</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Group 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_24_quantize_0/47&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_63_quantize_0/104&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_axes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_factors</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Group 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_63_quantize_0/104&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_117_quantize_0/188&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_axes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_factors</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Group 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;PPQ_Operation_117_quantize_0/188&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;softmax_Softmax_div_4/242&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_axes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">split_factors</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
</li>
<li>
<p>编译模型。</p>
<p>配置<code>--manual-partition-file</code>编译选项编译模型，指导MLTC对模型进行优化。</p>
<div class="language-Bash language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat compile_deepfm.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from mltc import Compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输入mlir文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_file = &quot;resnet50_stc.mlir&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 输出vmfb文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output_file = &quot;resnet50_stc.vmfb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 编译参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compile_args = &quot;-arch=npu-v1 --manual-partition-file=/home/resnet50.yml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compiler().compile(input_file, output_file, compile_args)</span><br></span></code></pre></div></div>
</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/推理软件使用手册/STCRP使用指南/MLTC使用指南.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/推理软件使用手册/STCRP使用指南/HPE使用指南"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">HPE使用指南</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/推理软件使用手册/STCRP使用指南/STC_LLM使用指南"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">STC_LLM使用指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mltc概述" class="table-of-contents__link toc-highlight">MLTC概述</a></li><li><a href="#前提条件" class="table-of-contents__link toc-highlight">前提条件</a></li><li><a href="#在npu上部署模型" class="table-of-contents__link toc-highlight">在NPU上部署模型</a><ul><li><a href="#tensorflow模型" class="table-of-contents__link toc-highlight">TensorFlow模型</a></li><li><a href="#onnx模型" class="table-of-contents__link toc-highlight">ONNX模型</a></li><li><a href="#pytorch模型" class="table-of-contents__link toc-highlight">PyTorch模型</a></li><li><a href="#故障排查" class="table-of-contents__link toc-highlight">故障排查</a></li></ul></li><li><a href="#在cpu上验证模型" class="table-of-contents__link toc-highlight">在CPU上验证模型</a></li><li><a href="#推理效果演示" class="table-of-contents__link toc-highlight">推理效果演示</a></li><li><a href="#分析推理性能" class="table-of-contents__link toc-highlight">分析推理性能</a><ul><li><a href="#使用限制" class="table-of-contents__link toc-highlight">使用限制</a></li><li><a href="#执行步骤" class="table-of-contents__link toc-highlight">执行步骤</a></li><li><a href="#使用示例" class="table-of-contents__link toc-highlight">使用示例</a></li></ul></li><li><a href="#分析精度" class="table-of-contents__link toc-highlight">分析精度</a><ul><li><a href="#执行步骤-1" class="table-of-contents__link toc-highlight">执行步骤</a></li><li><a href="#使用示例-1" class="table-of-contents__link toc-highlight">使用示例</a></li><li><a href="#常见问题" class="table-of-contents__link toc-highlight">常见问题</a></li></ul></li><li><a href="#生成量化模型" class="table-of-contents__link toc-highlight">生成量化模型</a><ul><li><a href="#执行步骤-2" class="table-of-contents__link toc-highlight">执行步骤</a></li><li><a href="#代码示例" class="table-of-contents__link toc-highlight">代码示例</a></li></ul></li><li><a href="#图分组性能调优" class="table-of-contents__link toc-highlight">图分组性能调优</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">希姆计算</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.streamcomputing.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">希姆计算官网<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.streamcomputing.com/index.php?s=about&amp;c=category&amp;id=1#a1" target="_blank" rel="noopener noreferrer" class="footer__link-item">关于希姆计算<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.streamcomputing.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">联系我们<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">开源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/riscv-stc/riscv-matrix-project" target="_blank" rel="noopener noreferrer" class="footer__link-item">自研AI计算矩阵扩展指令集<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/Stream-Computing/STCPaddleModelZoo" target="_blank" rel="noopener noreferrer" class="footer__link-item">百度飞桨 x 希姆计算AI模型库<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://riscv.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RISC-V International<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/希姆计算术语表">希姆计算术语表</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 广州希姆半导体科技有限公司Stream Computing Inc.</div></div></div></footer></div>
</body>
</html>